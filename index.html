<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Recycling POS</title>
<style>
  :root{
    --bg:#070c16; --bg2:#0b1320; --card:#0f1730; --muted:#8ca0c3;
    --accent:#7dd3fc; --ok:#22c55e; --danger:#ef4444; --ink:#e5efff;
    --border:#22314f33;
  }
  [data-theme="light"]{
    --bg:#f7fafc; --bg2:#eef2f7; --card:#ffffff; --muted:#5b6b83;
    --accent:#0ea5e9; --ok:#16a34a; --danger:#dc2626; --ink:#0b1320;
    --border:#d7e0ee;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    background:radial-gradient(80vw 80vh at 10% 10%, #0f1f3d 0%, var(--bg) 60%),
               linear-gradient(180deg, var(--bg2), var(--bg) 60%);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;
    padding-bottom:env(safe-area-inset-bottom);
  }
  .hidden{display:none!important}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .pill{background:color-mix(in oklab, var(--card) 70%, #0f1a2d); border:1px solid var(--border); border-radius:999px; padding:6px 10px; white-space:nowrap}
  .btn{padding:12px 16px; cursor:pointer; transition:transform .06s ease, filter .2s ease; font:inherit; border-radius:12px; border:1px solid var(--border); background:color-mix(in oklab, var(--card) 90%, #0e1b30 14%); color:var(--ink)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:color-mix(in oklab, var(--accent) 14%, var(--card)); border-color:var(--border)}
  .btn.success{background:var(--ok); border-color:#16a34a; color:#05210f}
  .btn.danger{background:var(--danger); border-color:#b91c1c}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  input,textarea{font:inherit; border-radius:12px; border:1px solid var(--border); background:color-mix(in oklab, var(--card) 92%, #0e1b30 14%); color:var(--ink); padding:12px}
  input[type=number]{text-align:center}

  .wrap{max-width:960px; margin:0 auto; padding:14px}
  header{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .badge{font-size:.72rem; color:var(--bg2); background:var(--accent); padding:4px 8px; border-radius:999px; font-weight:700}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid var(--border); text-align:left}
  .pricecell{white-space:nowrap}
  .sticky-bottom{position:sticky; bottom:0; background:linear-gradient(180deg,transparent,var(--bg2) 24%); padding-top:6px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px}
  .mat-btn{display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; background:color-mix(in oklab, var(--card) 92%, #0e1b3020); border:1px solid var(--border); border-radius:14px; padding:10px; min-height:104px; transition:transform .08s ease, box-shadow .2s ease}
  .mat-btn:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.15)}
  .mat-btn svg{width:40px; height:40px}
  .mat-btn span{font-size:.8rem; text-align:center}
  .fab{position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px; background:color-mix(in oklab, var(--card) 80%, #1f2b45); border:1px solid #2a3e6633; display:none; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(0,0,0,.20)}

  @media (max-width:420px){
    header .row{gap:6px}
    .btn{padding:10px 12px}
    .grid{grid-template-columns:repeat(3,1fr)}
  }

  @supports (-webkit-touch-callout: none) {
    @media screen and (device-width:430px) and (device-height:932px) and (-webkit-device-pixel-ratio:3) {
      .wrap{padding:12px}
      .btn{padding:14px 16px}
      .grid{grid-template-columns:repeat(4,1fr)}
      .mat-btn{min-height:112px}
      header .row{gap:6px}
      body{padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
    }
  }
</style>

<!-- QR + Scanner libs -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<!-- Firebase compat (Firestore only) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="appShell">
  <div class="wrap">
    <header>
      <h1>Recycling<span class="badge">POS</span></h1>
      <div class="row" style="gap:8px;align-items:center">
        <span id="cloudStatus" class="pill">Cloud: offline</span>
        <button id="scanBtn" class="btn">Scan</button>
        <button id="openPrices" class="btn">Prices</button>
        <button id="viewOrders" class="btn">Orders</button>
        <button id="themeBtn" class="btn" title="Toggle theme">â˜€ï¸Ž/ðŸŒ™</button>
      </div>
    </header>

    <div id="mainLayout">
      <div class="row" style="margin-top:12px">
        <!-- ENTRY -->
        <div id="entryCard" class="card" style="flex:1;min-width:280px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <b>Entry</b>
            <label class="row" style="align-items:center;gap:6px">
              <input type="checkbox" id="cntMode"><span class="hint">CNT (Count mode)</span>
            </label>
          </div>

          <div id="weightBox" class="card" style="margin-top:10px">
            <label for="pounds">Weight (lb)</label>
            <input id="pounds" type="number" step="0.01" inputmode="decimal" min="0" value="0" enterkeyhint="done">
            <div class="hint" id="weightPreview">$0.00</div>
          </div>

          <div id="countBox" class="card" style="margin-top:10px;display:none">
            <label for="qty">Count (auto-CRV / special)</label>
            <input id="qty" type="number" inputmode="numeric" pattern="[0-9]*" value="0" min="0" enterkeyhint="done">
            <div class="hint" id="countPreview">$0.00</div>
          </div>
        </div>

        <!-- ORDER -->
        <div id="orderCard" class="card" style="flex:1;min-width:280px">
          <h3 style="margin:0 0 6px">Current Order</h3>
          <div class="hint" id="chosenMatLabel" style="margin:4px 0 8px">Material: â€”</div>
          <table id="orderTable">
            <thead>
              <tr><th>Item</th><th>Detail</th><th class="pricecell">Subtotal</th><th></th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr><td colspan="2">CRV total</td><td class="pricecell" id="crvTotal">$0.00</td><td></td></tr>
              <tr><td colspan="2">Weight total</td><td class="pricecell" id="weightTotal">$0.00</td><td></td></tr>
              <tr><td colspan="2">Grand total</td><td class="pricecell" id="grandTotal">$0.00</td><td></td></tr>
            </tfoot>
          </table>
          <div class="sticky-bottom">
            <div class="row" style="justify-content:space-between;gap:8px">
              <button id="clearOrder" class="btn danger">Clear</button>
              <div class="row" style="gap:8px">
                <button id="printLast" class="btn" disabled>Receipt</button>
                <button id="saveOrder" class="btn success">Save Order</button>
              </div>
            </div>
            <p class="hint" id="saveHint"></p>
          </div>
        </div>
      </div>

      <!-- MATERIALS -->
      <div id="materialsCard" class="card" style="margin-top:12px">
        <label style="display:block;margin-bottom:8px">Materials</label>
        <div id="matGrid" class="grid"></div>
        <div id="choicePanel" class="row" style="gap:10px;display:none;flex-wrap:wrap"></div>
        <div class="hint" id="pickedHint">
          Weight by default. Enter lbs first, then tap a material; grid hides and shows
          CRV (left) / Non-CRV (right). If <b>CNT</b> is checked, enter quantity then tap
          material to get &lt;24 (5Â¢) / â‰¥24 (10Â¢). <b>Bag-in-Box, Pouch, Carton = 25Â¢ each</b>.
          Aluminum right button = $1.75/lb. <b>Non-CRV has no payout.</b>
        </div>
      </div>
    </div>

  </div>

  <button id="editFab" class="fab" aria-label="Back to materials" title="Back to materials"><span>âœŽ</span></button>

  <!-- Prices Modal -->
  <dialog id="pricesModal" style="border:0;padding:0;border-radius:16px;background:var(--card);color:var(--ink);width:min(720px,92vw)">
    <div class="card" style="border:0">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Edit Prices ($/lb)</h3>
        <button class="btn" onclick="document.getElementById('pricesModal').close()">âœ•</button>
      </div>
      <div id="priceGrid" class="row" style="flex-direction:column"></div>
      <div class="row" style="justify-content:space-between;margin-top:10px;align-items:center">
        <span id="priceSyncState" class="pill">Prices stored locally</span>
        <div>
          <button class="btn primary" id="savePrices">Save</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Orders Modal -->
  <dialog id="ordersModal" style="border:0;padding:0;border-radius:16px;background:var(--card);color:var(--ink);width:min(720px,96vw)">
    <div class="card" style="border:0">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Saved Orders</h3>
        <button class="btn" onclick="document.getElementById('ordersModal').close()">âœ•</button>
      </div>
      <div id="ordersList"></div>
    </div>
  </dialog>

  <!-- Code Modal -->
  <dialog id="barcodeModal" style="border:0;padding:0;border-radius:16px;background:var(--card);color:var(--ink);width:min(560px,96vw)">
    <div class="card" style="border:0">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Order Code</h3>
        <div class="row">
          <button id="printBar" class="btn">Print</button>
          <button class="btn" onclick="document.getElementById('barcodeModal').close()">âœ•</button>
        </div>
      </div>
      <div style="width:100%;text-align:center">
        <canvas id="qrCanvas" style="width:100%;max-width:320px;height:auto;background:#ffffff;border-radius:12px"></canvas>
      </div>
      <div class="hint" id="barcodeHint" style="margin-top:8px;word-break:break-all;text-align:center"></div>
    </div>
  </dialog>

  <!-- Scanner Modal -->
  <dialog id="scanModal" style="border:0;padding:0;border-radius:16px;background:var(--card);color:var(--ink);width:min(720px,96vw)">
    <div class="card" style="border:0">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Scan Code</h3>
        <button class="btn" onclick="stopScan();document.getElementById('scanModal').close()">âœ•</button>
      </div>
      <video id="video" playsinline style="width:100%;border-radius:12px;background:#000"></video>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <span class="pill" id="camState">Camera: idle</span>
        <button id="startCam" class="btn primary">Start</button>
      </div>
      <div id="scanResult" class="hint" style="margin-top:8px">Point camera at QR or barcode.</div>
      <div id="scanOrder" style="display:none"></div>
    </div>
  </dialog>
</div>

<script>
/* Helpers */
const $ = (q)=>document.querySelector(q);
const on = (sel, evt, fn)=>{ const el=$(sel); if(el) el.addEventListener(evt, fn, {passive:true}); };
const set = (sel, text)=>{ const el=$(sel); if(el) el.textContent = text; };
const money = (n)=> (isNaN(n)?0:n).toLocaleString(undefined,{style:'currency',currency:'USD'});
const setCloud = (text)=> set('#cloudStatus', text);

/* Theme */
(function(){
  const saved = localStorage.getItem('sr_theme')||'';
  if(saved==='light') document.documentElement.setAttribute('data-theme','light');
  on('#themeBtn','click', ()=>{
    const isLight = document.documentElement.getAttribute('data-theme')==='light';
    document.documentElement.setAttribute('data-theme', isLight?'':'light');
    localStorage.setItem('sr_theme', isLight?'dark':'light');
  });
})();

/* Storage keys */
const ORDERS_KEY = 'sr_orders_v1';
const PRICES_KEY = 'sr_prices';

/* Icons & materials */
const icons={
  can:`<svg viewBox='0 0 64 64' fill='none'><rect x='18' y='4' width='28' height='56' rx='6' stroke='#7dd3fc' stroke-width='3'/><rect x='22' y='10' width='20' height='44' rx='3' fill='#1a2744'/></svg>`,
  bottle:`<svg viewBox='0 0 64 64' fill='none'><path d='M28 6h8v8a8 8 0 0 1 4 7v30a8 8 0 0 1-8 8h0a8 8 0 0 1-8-8V21a8 8 0 0 1 4-7V6z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/></svg>`,
  jug:`<svg viewBox='0 0 64 64' fill='none'><path d='M20 14h16l8 8v28a8 8 0 0 1-8 8H24a8 8 0 0 1-8-8V22a8 8 0 0 1 4-8z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/><rect x='36' y='18' width='10' height='8' rx='2' stroke='#7dd3fc' stroke-width='3'/></svg>`,
  glass:`<svg viewBox='0 0 64 64' fill='none'><path d='M16 6h32l-6 40a10 10 0 0 1-10 8h0a10 10 0 0 1-10-8L16 6z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/></svg>`,
  steel:`<svg viewBox='0 0 64 64' fill='none'><rect x='14' y='10' width='36' height='48' rx='6' stroke='#7dd3fc' stroke-width='3'/><path d='M18 22h28M18 30h28M18 38h28' stroke='#7dd3fc' stroke-width='2'/></svg>`,
  cup:`<svg viewBox='0 0 64 64' fill='none'><path d='M14 10h36l-6 36a10 10 0 0 1-10 8h0a10 10 0 0 1-10-8L14 10z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/></svg>`,
  seven:`<svg viewBox='0 0 64 64' fill='none'><polygon points='8,12 56,12 28,56 12,56' stroke='#7dd3fc' stroke-width='3' fill='none'/><text x='28' y='40' fill='#7dd3fc' font-size='24' text-anchor='middle' font-family='monospace'>7</text></svg>`,
  pouch:`<svg viewBox='0 0 64 64' fill='none'><path d='M20 10h24l6 10v28l-6 6H20l-6-6V20l6-10z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/></svg>`,
  baginbox:`<svg viewBox='0 0 64 64' fill='none'><rect x='10' y='12' width='44' height='40' rx='6' stroke='#7dd3fc' stroke-width='3' fill='none'/><circle cx='46' cy='44' r='6' stroke='#7dd3fc' stroke-width='3'/><path d='M44 44h4' stroke='#7dd3fc' stroke-width='3'/></svg>`,
  carton:`<svg viewBox='0 0 64 64' fill='none'><path d='M22 12h20l6 10v28a6 6 0 0 1-6 6H22a6 6 0 0 1-6-6V22l6-10z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/><path d='M42 12l6 10H22' stroke='#7dd3fc' stroke-width='2'/><path d='M44 18c6 2 8 2 10 2' stroke='#7dd3fc' stroke-width='2'/></svg>`
};
const materials={
  ALUMINUM:{label:'Aluminum',unit:'lb',icon:icons.can},
  GLASS:{label:'Glass',unit:'lb',icon:icons.glass},
  PET1:{label:'#1 PET',unit:'lb',icon:icons.bottle},
  HDPE2:{label:'#2 HDPE',unit:'lb',icon:icons.jug},
  PVC3:{label:'#3 PVC',unit:'lb',icon:icons.bottle},
  LDPE4:{label:'#4 LDPE',unit:'lb',icon:icons.bottle},
  PP5:{label:'#5 PP',unit:'lb',icon:icons.cup},
  PS6:{label:'#6 PS',unit:'lb',icon:icons.cup},
  OTHER7:{label:'#7 Other Plastic',unit:'lb',icon:icons.seven},
  BIMETAL:{label:'Bi-metal',unit:'lb',icon:icons.steel},
  Pouch:{label:'Multi-Layer Pouch',unit:'lb',icon:icons.pouch},
  BagInBox:{label:'Bag-in-Box (wine)',unit:'lb',icon:icons.baginbox},
  JuiceBox:{label:'Paperboard Carton (BeatBox)',unit:'ea',icon:icons.carton}
};

let prices = JSON.parse(localStorage.getItem(PRICES_KEY)||'null') || {
  ALUMINUM:1.65,
  GLASS:0.102,
  PET1:1.47,
  HDPE2:0.63,
  PVC3:0.48,
  LDPE4:0.98,
  PP5:0.55,
  PS6:0.31,
  OTHER7:0.41,
  BIMETAL:0.825,
  Pouch:0.41,
  BagInBox:3.79,
  JuiceBox_each:0.25
};

let selectedMat=null;
const order=[];

/* Build material grid */
(function(){
  const g=$('#matGrid');
  g.innerHTML='';
  Object.entries(materials).forEach(([k,v])=>{
    const b=document.createElement('button');
    b.className='mat-btn';
    b.innerHTML=`${v.icon}<span>${v.label}</span>`;
    b.addEventListener('click',()=>onMaterial(k));
    g.appendChild(b);
  });
})();

/* CNT vs weight */
function isCount(){ return $('#cntMode')?.checked; }
function updatePanels(){
  $('#countBox').style.display=isCount()?'block':'none';
  $('#weightBox').style.display=isCount()?'none':'block';
}
on('#cntMode','change',()=>{ updatePanels(); restoreGrid(); });
updatePanels();

/* Input helpers */
function autoPrep(sel){ const el=$(sel); if(!el) return; if(el.value==='0'||el.value==='0.00') el.value=''; el.select?.(); }
function autoRestore(sel){ const el=$(sel); if(!el) return; if(!el.value) el.value='0'; }
['#pounds','#qty'].forEach(id=>{
  on(id,'focus', ()=>autoPrep(id));
  on(id,'blur',  ()=>autoRestore(id));
});
on('#editFab','click', ()=>{ restoreGrid(); window.scrollTo({top:document.getElementById('materialsCard').offsetTop-20, behavior:'smooth'}); });

/* Material flow */
function onMaterial(key){
  selectedMat=key;
  set('#chosenMatLabel','Material: '+materials[key].label);

  const p = $('#choicePanel'); p.innerHTML='';
  const grid = $('#matGrid');

  const showPanel = ()=>{
    grid.style.display='none';
    p.style.display='flex';
    $('#editFab').style.display = 'flex';
  };

  if(isCount()){
    const qty=+($('#qty')?.value||0);
    if(!qty){ flashHint('Enter count first'); return; }
    showPanel();
    if(key==='BagInBox' || key==='Pouch' || key==='JuiceBox'){
      p.append(makeBtn('25Â¢ each',()=>{addCountItem(0.25); restoreGrid();}));
    }else{
      p.append(
        makeBtn('< 24 oz (5Â¢)', ()=>{addCountItem(0.05); restoreGrid();} ),
        makeBtn('â‰¥ 24 oz (10Â¢)',()=>{addCountItem(0.10); restoreGrid();} )
      );
    }
  }else{
    const lbs=+($('#pounds')?.value||0);
    if(!lbs){ flashHint('Enter weight first'); return; }
    showPanel();
    p.append(
      makeBtn('CRV',()=>{addWeightItem('CRV'); restoreGrid();} ),
      makeBtn(key==='ALUMINUM'?'$1.75/lb':'Non-CRV',()=>{addWeightItem(key==='ALUMINUM'?'ALU175':'NON'); restoreGrid();} )
    );
  }
}
function makeBtn(txt,fn){ const b=document.createElement('button'); b.className='btn primary'; b.textContent=txt; b.addEventListener('click',fn); return b; }
function restoreGrid(){
  const p=$('#choicePanel'); if(p) p.style.display='none';
  const g=$('#matGrid'); if(g) g.style.display='grid';
  set('#chosenMatLabel','Material: â€”');
  selectedMat=null;
  $('#editFab').style.display='none';
}
function flashHint(msg){
  const el = $('#pickedHint');
  if(!el) return;
  const prev=el.textContent;
  el.textContent=msg;
  setTimeout(()=>el.textContent=prev,1200);
}

/* Previews */
on('#pounds','input', ()=>{
  const lbs=+($('#pounds')?.value||0);
  const rate=(selectedMat && prices[selectedMat])||0;
  set('#weightPreview', money(lbs*rate));
});
on('#qty','input',    ()=>{
  const qty=+($('#qty')?.value||0);
  set('#countPreview', money(qty*0.05));
});

/* Add items */
function addWeightItem(kind){
  if(!selectedMat){ alert('Pick a material below.'); return;}
  const lbs = +($('#pounds')?.value||0);
  if(!lbs) return;

  let rate=(prices[selectedMat]||0);
  let tag='', subtotal=0;

  if(selectedMat==='ALUMINUM' && kind==='ALU175'){
    rate=1.75; tag='Alu $1.75'; subtotal=lbs*rate;
  }else if(kind==='CRV'){
    tag='CRV'; subtotal=lbs*rate;
  }else{
    tag='Non-CRV (no payout)'; subtotal=0;
  }

  order.push({
    type:'weight', mat:selectedMat, lbs, unitPrice:rate, payoutKind:kind,
    subtotal,
    detail:`${tag} Â· ${lbs.toFixed(2)} lb Ã— ${money(rate)}/lb${subtotal===0?' â€” no payout':''}`
  });

  $('#pounds').value='0';
  render();
}
function addCountItem(per){
  if(!selectedMat){ alert('Pick a material below.'); return;}
  const qty = +($('#qty')?.value||0);
  if(!qty) return;
  order.push({
    type:'crv',mat:selectedMat,qty,unitPrice:per,
    subtotal:qty*per,
    detail:`${qty} Ã— ${(per===0.25?'25Â¢':per===0.10?'10Â¢':'5Â¢')}`
  });
  $('#qty').value='0';
  render();
}

/* Render order */
function render(){
  const tb=$('#orderTable tbody');
  tb.innerHTML='';
  let crv=0,wt=0;
  order.forEach((it,i)=>{
    const nm=(materials[it.mat]||{label:it.mat}).label;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${nm}</td><td>${it.detail}</td><td class="pricecell">${money(it.subtotal)}</td><td><button class='btn' data-i='${i}'>âœ•</button></td>`;
    tb.appendChild(tr);
    if(it.type==='weight') wt+=it.subtotal; else crv+=it.subtotal;
  });
  set('#crvTotal', money(crv));
  set('#weightTotal', money(wt));
  set('#grandTotal', money(crv+wt));
  tb.querySelectorAll('button[data-i]').forEach(b=>b.addEventListener('click',()=>{order.splice(+b.dataset.i,1); render();}));
  $('#printLast').disabled = order.length===0;
}

/* Clear with confirmation */
let clearConfirm=false;
on('#clearOrder','click',()=>{
  if(!order.length) return;
  const btn = $('#clearOrder');
  if(!clearConfirm){
    clearConfirm=true;
    const prevText = btn.textContent;
    btn.dataset.prev = prevText;
    btn.textContent = 'Confirm';
    set('#saveHint','Tap Clear again to confirm.');
    setTimeout(()=>{
      if(clearConfirm){
        clearConfirm=false;
        btn.textContent = btn.dataset.prev || 'Clear';
        set('#saveHint','');
      }
    },2000);
    return;
  }
  clearConfirm=false;
  btn.textContent = btn.dataset.prev || 'Clear';
  set('#saveHint','');
  order.splice(0,order.length);
  render();
});

/* Orders save / load */
let __lastSavedOrder = null;
function currentTotals(){
  return {
    crv:   $('#crvTotal').textContent || '$0.00',
    weight:$('#weightTotal').textContent || '$0.00',
    grand: $('#grandTotal').textContent || '$0.00',
  };
}
on('#printLast', ()=>{ if(__lastSavedOrder) printReceipt(__lastSavedOrder); else alert('Save an order first.'); });

function loadOrders(){
  try{ return JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]'); }
  catch(e){ return []; }
}
function saveOrders(arr){
  localStorage.setItem(ORDERS_KEY, JSON.stringify(arr.slice(0,100)));
}

async function saveOrderCommon(){
  set('#saveHint','');
  if(!order.length){
    set('#saveHint','Add some items first.');
    return;
  }

  const payload={
    id:'SR-'+Date.now(),
    when:new Date().toISOString(),
    items:[...order],
    totals: currentTotals()
  };

  // local
  const all = loadOrders();
  all.unshift(payload);
  saveOrders(all);

  // cloud best-effort
  try{
    if(window.cloud) await window.cloud.saveOrder(payload);
  }catch(e){
    console.warn('cloud save failed',e);
    set('#saveHint','Saved locally (cloud error).');
  }

  __lastSavedOrder = payload;
  $('#printLast').disabled=false;
  order.splice(0,order.length); render();
  if(!$('#saveHint').textContent) set('#saveHint','Saved âœ”');
  if('vibrate' in navigator) navigator.vibrate?.(10);
  setTimeout(()=>set('#saveHint',''),1500);
}
on('#saveOrder', ()=>{ saveOrderCommon(); });

/* Prices */
on('#openPrices','click', ()=>{ buildPricesForm(); $('#pricesModal').showModal(); });
function buildPricesForm(){
  const grid=$('#priceGrid'); grid.innerHTML='';
  Object.keys(materials).forEach(k=>{
    if(materials[k].unit==='ea') return;
    const row=document.createElement('div'); row.className='row'; row.style.flexDirection='column';
    row.innerHTML=`<label>${materials[k].label}</label><input type='number' step='0.001' id='p_${k}' value='${prices[k]??''}' placeholder='$/lb'>`;
    grid.appendChild(row);
  });
  const jb=document.createElement('div'); jb.className='row'; jb.style.flexDirection='column';
  jb.innerHTML=`<label>Paperboard Carton (BeatBox) â€“ price each</label><input type='number' step='0.01' id='p_JuiceBox_each' value='${prices.JuiceBox_each??0.25}' placeholder='$/ea'>`;
  grid.appendChild(jb);
}
on('#savePrices','click', async ()=>{
  const next={};
  Object.keys(materials).forEach(k=>{
    if(materials[k].unit==='lb'){
      const el=$('#p_'+k);
      next[k]=+(el && el.value ? el.value : 0) || 0;
    }
  });
  const jb=$('#p_JuiceBox_each');
  next.JuiceBox_each=+(jb && jb.value ? jb.value : 0.25) || 0.25;
  prices={...prices,...next};
  localStorage.setItem(PRICES_KEY,JSON.stringify(prices));

  try{
    if(window.cloud) await window.cloud.setPrices(prices);
    set('#priceSyncState','Prices synced to cloud');
  }catch(e){
    set('#priceSyncState','Prices stored locally (cloud failed)');
  }
  document.getElementById('pricesModal').close();
});

/* Orders modal */
on('#viewOrders','click', async ()=>{
  const list=$('#ordersList'); list.innerHTML='';
  let all=[];
  try{
    if(window.cloud && window.firebaseReady){
      all = await window.cloud.listOrders();
      if(all && all.length) saveOrders(all);
    }else{
      all = loadOrders();
    }
  }catch(e){
    console.warn('orders cloud list failed',e);
    all = loadOrders();
  }

  if(!all || !all.length){
    list.innerHTML='<div class="hint">No orders yet.</div>';
    document.getElementById('ordersModal').showModal(); return;
  }
  all.forEach(o=>{
    const div=document.createElement('div'); div.className='card';
    const header=document.createElement('div'); header.className='row'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    const left=document.createElement('b'); left.textContent=o.id || '(no id)';

    const codeBtn=document.createElement('button'); codeBtn.className='btn primary'; codeBtn.textContent='Code';
    codeBtn.addEventListener('click',()=>showBarcode(o.id || o._id || ''));

    const rbtn=document.createElement('button'); rbtn.className='btn'; rbtn.textContent='Receipt';
    rbtn.style.marginLeft='6px';
    rbtn.addEventListener('click',()=>printReceipt(o));

    const right=document.createElement('span'); right.className='hint'; right.textContent=new Date(o.when||Date.now()).toLocaleString();
    header.append(left,codeBtn,rbtn,right);

    const ul=document.createElement('ul');
    ul.innerHTML=(o.items||[]).map(it=>`<li>${(materials[it.mat]||{label:it.mat}).label} â€” ${it.detail} <b>${money(it.subtotal)}</b></li>`).join('');
    const totals=document.createElement('div'); totals.className='row'; totals.style.justifyContent='flex-end'; totals.style.gap='16px';
    totals.innerHTML=`<span>CRV: <b>${o.totals?.crv||'$0.00'}</b></span><span>Weight: <b>${o.totals?.weight||'$0.00'}</b></span><span>Grand: <b>${o.totals?.grand||'$0.00'}</b></span>`;
    div.append(header,ul,totals); list.appendChild(div);
  });
  document.getElementById('ordersModal').showModal();
});

/* QR for orders */
function codeColors(){
  const isLight = document.documentElement.getAttribute('data-theme')==='light';
  return isLight
    ? { dark:'#111111', light:'#ffffff' }
    : { dark:'#000000', light:'#ffffff' };
}
function showBarcode(text){
  const value = text && String(text).trim() ? String(text).trim() : 'NO-ID';
  set('#barcodeHint', value);

  const canvas = $('#qrCanvas');
  const ctx = canvas.getContext('2d');
  // white background
  const w = canvas.width = 320;
  const h = canvas.height = 320;
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,w,h);

  try{
    const cc = codeColors();
    QRCode.toCanvas(canvas, value, {
      width: 320,
      margin: 1,
      color:{ dark: cc.dark, light: cc.light }
    }, function(err){
      if(err) console.warn('QR error', err);
    });
  }catch(e){ console.warn('QR lib error', e); }

  document.getElementById('barcodeModal').showModal();
}
on('#printBar','click', ()=>{
  const canvas=$('#qrCanvas');
  const w=window.open('','printqr');
  const html=`<!doctype html><html><head><meta charset="utf-8"><title>Order Code</title>
  <style>body{margin:0;padding:20px;text-align:center;background:#fff}</style></head>
  <body><img src="${canvas.toDataURL('image/png')}" style="max-width:320px;width:100%">
  <script>window.onload=function(){setTimeout(function(){window.print();setTimeout(function(){window.close();},300);},200);};<\/script>
  </body></html>`;
  w.document.write(html);
  w.document.close();
});

/* Scanner */
let stream=null, codeReader=null;
const scanModalEl = document.getElementById('scanModal');
if(scanModalEl){
  scanModalEl.addEventListener('close', stopScan, {passive:true});
  scanModalEl.addEventListener('cancel', stopScan, {passive:true});
}
on('#scanBtn','click', ()=>{
  $('#scanOrder').style.display='none';
  set('#scanResult','Point camera at QR or barcode.');
  document.getElementById('scanModal').showModal();
});
async function startScan(){
  try{
    if(!navigator.mediaDevices?.getUserMedia){
      set('#camState','Camera: unsupported');
      return;
    }
    const constraints = { video: { facingMode: { ideal: 'environment' } } };
    set('#camState','Camera: startingâ€¦');
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    const v=$('#video'); v.srcObject=stream; await v.play();
    set('#camState','Camera: on âœ”');
    codeReader = new ZXing.BrowserMultiFormatReader();
    await codeReader.decodeFromVideoDevice(null, v, async (result, err)=>{
      if(result){
        const val = result.getText ? result.getText() : (result.text || '');
        if(val){ await onScan(val); }
      }
    });
  }catch(e){ set('#camState','Camera: error'); alert(e.message||e); }
}
function stopScan(){
  try{
    if(codeReader){ codeReader.reset(); codeReader=null; }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    set('#camState','Camera: idle');
  }catch(e){}
}
on('#startCam','click', ()=>{ if(stream){ stopScan(); } else { startScan(); } });

async function onScan(val){
  if(!val) return;
  stopScan();
  set('#scanResult','Scanned: '+val);
  let o=null;
  try{
    if(window.cloud) o = await window.cloud.getOrder(val);
  }catch(e){}
  if(!o){
    const all = loadOrders();
    o = all.find(x=>x.id===val) || null;
  }
  const panel = $('#scanOrder');
  if(o){
    const rows=(o.items||[]).map(it=>`<li>${(materials[it.mat]||{label:it.mat}).label} â€” ${it.detail} <b>${money(it.subtotal)}</b></li>`).join('');
    panel.style.display='block';
    panel.innerHTML=`<h3 style='margin:10px 0'>${o.id}</h3>
      <div class='hint'>${new Date(o.when||Date.now()).toLocaleString()}</div>
      <ul>${rows}</ul>
      <div class='row' style='justify-content:flex-end;gap:16px'>
        <span>CRV: <b>${o.totals?.crv||'$0.00'}</b></span>
        <span>Weight: <b>${o.totals?.weight||'$0.00'}</b></span>
        <span>Grand: <b>${o.totals?.grand||'$0.00'}</b></span>
      </div>
      <div class='row' style='justify-content:center;margin-top:10px'>
        <button class='btn primary' onclick='(${startScan.toString()})();'>Scan Again</button>
      </div>`;
  } else {
    panel.style.display='block';
    panel.innerHTML = "<div class='hint'>No matching order found (cloud/local).</div>";
  }
}

/* Receipt printing */
function buildReceiptHTML(order){
  const items = (order.items||[]);
  const lines = items.map(it=>{
    const name=(materials[it.mat]||{label:it.mat}).label;
    const noPay = (it.type==='weight' && (it.payoutKind==='NON' || (typeof it.subtotal==='number' && it.subtotal===0)));
    return `<tr><td>${name}</td><td>${it.detail}${noPay?'':' '}</td></tr>`;
  }).join('');

  const lbsTotal = items.filter(it=>it.type==='weight').reduce((a,b)=>a+(+b.lbs||0),0);
  const lbsNoPay = items
    .filter(it=>it.type==='weight' && (it.payoutKind==='NON' || (typeof it.subtotal==='number' && it.subtotal===0)))
    .reduce((a,b)=>a+(+b.lbs||0),0);
  const cntCRV  = items.filter(it=>it.type==='crv').reduce((a,b)=>a+(+b.qty||0),0);

  const grand = order.totals?.grand || '$0.00';
  const when  = new Date(order.when||Date.now()).toLocaleString();
  const id    = order.id || 'UNSAVED';

  return `<!doctype html><html><head><meta charset="utf-8"><title>Receipt ${id}</title>
  <style>@media print{@page{margin:8mm}body{margin:0}}body{font-family:ui-monospace,Menlo,Consolas,monospace;color:#111;padding:12px;line-height:1.25}
  .center{text-align:center}.small{font-size:12px;color:#333}table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{padding:4px 0;border-bottom:1px dashed #ccc;font-size:14px}thead th{border-bottom:1px solid #000}
  .logo{font-weight:700;letter-spacing:.5px;font-size:16px}.muted{color:#666}
  .box{border:1px dashed #bbb;padding:6px;border-radius:8px;margin-top:8px}</style>
  </head><body>
    <div class="center logo">Recycling Receipt</div>
    <div class="center small">${when}</div>
    <div class="small">Order ID: <b>${id}</b></div>

    <table>
      <thead><tr><th style="text-align:left">Item</th><th style="text-align:left">Detail</th></tr></thead>
      <tbody>${lines || '<tr><td colspan="2" class="muted">No items</td></tr>'}</tbody>
      <tfoot>
        <tr><td colspan="2" style="text-align:right;font-size:16px">GRAND TOTAL: <span style="display:inline-block;min-width:96px">${grand}</span></td></tr>
      </tfoot>
    </table>

    <div class="box">
      <div class="small">Summary</div>
      <div class="small">Weight received: <b>${lbsTotal.toFixed(2)} lb</b> &nbsp; | &nbsp; Non-CRV (no payout): <b>${lbsNoPay.toFixed(2)} lb</b> &nbsp; | &nbsp; CRV containers: <b>${cntCRV}</b></div>
      <div class="small muted">Non-CRV materials are accepted but do not pay out. Thanks for keeping recyclables out of landfill!</div>
    </div>

    <script>
      window.onload = function(){
        setTimeout(function(){
          window.print();
          setTimeout(function(){ window.close(); }, 300);
        }, 200);
      };
    <\/script>
  </body></html>`;
}
function printReceipt(order){
  if(!order){ alert('No order to print'); return; }
  const w=window.open('','receipt');
  w.document.write(buildReceiptHTML(order));
  w.document.close();
}

/* Firebase: Firestore only */
window.cloud = null;
window.firebaseReady = false;

const fbCfg = {
  apiKey: "AIzaSyCSRYYjuJyO6_N2n9RaA8T2fXRaHiC3q6o",
  authDomain: "recycle-cb24b.firebaseapp.com",
  projectId: "recycle-cb24b",
  storageBucket: "recycle-cb24b.firebasestorage.app",
  messagingSenderId: "281209650356",
  appId: "1:281209650356:web:a3b55a3b4d7ce5e642abe1",
  measurementId: "G-4DFFS1RH83"
};

(function initFirebase(){
  if (typeof firebase === 'undefined') {
    setCloud('Cloud: unavailable');
    return;
  }
  try {
    const app = firebase.initializeApp(fbCfg);
    const db  = firebase.firestore();

    db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

    window.cloud = {
      async saveOrder(o){ return db.collection('orders').doc(o.id).set(o); },
      async getOrder(id){
        const s = await db.collection('orders').doc(id).get();
        return s.exists ? { id: s.data().id || s.id, ...s.data() } : null;
      },
      async listOrders(){
        const s = await db.collection('orders')
          .orderBy('when','desc')
          .limit(100)
          .get();
        return s.docs.map(d => {
          const data = d.data() || {};
          return { id: data.id || d.id, ...data };
        });
      },
      async getPrices(){
        const s = await db.collection('settings').doc('prices').get();
        return s.exists ? s.data() : null;
      },
      async setPrices(map){
        return db.collection('settings').doc('prices').set({
          map,
          updatedAt: new Date().toISOString()
        });
      }
    };

    db.collection('meta').doc('ping')
      .set({ ts: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true })
      .then(async () => {
        window.firebaseReady = true;
        setCloud('Cloud: online');

        try {
          const doc = await window.cloud.getPrices();
          if (doc && doc.map) {
            prices = { ...prices, ...doc.map };
            localStorage.setItem(PRICES_KEY, JSON.stringify(prices));
          }
        } catch (e) {
          console.warn('price sync failed', e);
        }
      })
      .catch(err => {
        console.warn('Firestore ping failed', err);
        setCloud('Cloud: offline');
        window.cloud = null;
      });

    setCloud('Cloud: connectingâ€¦');
  } catch (e) {
    console.error('Firebase init error', e);
    setCloud('Cloud: error');
    window.cloud = null;
  }
})();
</script>
</body>
</html>
