<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login</title>
<style>
  :root{
    --bg:#070c16; --bg2:#0b1320; --card:#0f1730; --muted:#8ca0c3;
    --accent:#7dd3fc; --ok:#22c55e; --danger:#ef4444; --ink:#e5efff
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(80vw 80vh at 10% 10%, #0f1f3d 0%, #070c16 60%), linear-gradient(180deg, #0b1320, #070c16 60%);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
  .hidden{display:none !important}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .pill{background:#0f1a2d; border:1px solid #22314f; border-radius:999px; padding:6px 10px; white-space:nowrap}
  .btn{padding:12px 16px; cursor:pointer; transition:transform .06s ease, filter .2s ease; font:inherit; border-radius:12px; border:1px solid #22314f; background:#0e1b30; color:var(--ink)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:#133a63; border-color:#16446f}
  .btn.success{background:var(--ok); border-color:#16a34a; color:#05210f}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  input,textarea{font:inherit; border-radius:12px; border:1px solid #22314f; background:#0e1b30; color:var(--ink); padding:12px}
  /* --- Auth Screen --- */
  #authScreen{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    padding:24px; background:radial-gradient(60vw 60vh at 20% 10%, #112346 0%, #070c16 60%); overflow:auto;
  }
  .auth-card{ width:min(520px, 96vw); background:rgba(17,26,43,.8); backdrop-filter: blur(10px);
    border:1px solid #22314f; border-radius:18px; padding:18px; box-shadow:0 20px 80px rgba(0,0,0,.45)}
  .title{display:flex; align-items:center; gap:10px; margin:0 0 8px}
  .title .dot{width:12px; height:12px; border-radius:999px; background:var(--accent); box-shadow:0 0 16px #7dd3fc}
  .subtitle{color:var(--muted); margin:0 0 12px}
  .hint{color:var(--muted); font-size:.9rem; min-height:1.2em}
  /* App shell basics retained from previous versions */
  .wrap{max-width:960px; margin:0 auto; padding:14px}
  header{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .badge{font-size:.72rem; color:#0b1320; background:var(--accent); padding:4px 8px; border-radius:999px; font-weight:700}
  .card{background:#0f1730; border:1px solid #22314f; border-radius:16px; padding:12px}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid #22314f; text-align:left}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px}
  .mat-btn{display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; background:#0e1b30; border:1px solid #22314f; border-radius:14px; padding:10px; min-height:104px}
  .fab{position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px; background:#1f2b45; border:1px solid #2a3e66; display:none; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(0,0,0,.35)}
  video{width:100%; border-radius:16px; background:#000}
</style>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-card">
    <div class="title"><span class="dot"></span><h1 style="margin:0;font-size:1.6rem">Login</h1></div>
    <p class="subtitle">Sign in to access orders & scanning.</p>
    <div class="row" style="flex-direction:column; gap:8px">
      <label>Email</label>
      <input id="authEmail" placeholder="example@gmail.com" autocomplete="username" />
      <label>Password</label>
      <input id="authPass" type="password" placeholder="••••" autocomplete="current-password" />
      <div class="row" style="justify-content:space-between; align-items:center">
        <span id="authHint" class="hint">Enter your staff email and password.</span>
        <button id="authLogin" class="btn success">Sign in</button>
      </div>
      <div class="row" style="justify-content:space-between; align-items:center">
        <span id="cloudState" class="pill">Cloud: starting…</span>
        <button id="cloudShow" class="btn">Cloud config</button>
      </div>
    </div>
  </div>
</div>

<!-- APP SHELL (hidden until authenticated) -->
<div id="appShell" class="hidden">
  <div class="wrap">
    <header>
      <h1>Recycling<span class="badge">POS</span></h1>
      <div class="row" style="gap:8px;align-items:center">
        <span id="cloudStatus" class="pill">Cloud: not connected</span>
        <span id="staffStatus" class="pill">Staff: guest</span>
        <button id="scanBtn" class="btn">Scan</button>
        <button id="openPrices" class="btn">Prices</button>
        <button id="viewOrders" class="btn">Orders</button>
        <button id="cloudBtn" class="btn primary">Cloud</button>
        <button id="staffBtn" class="btn">Staff</button>
      </div>
    </header>

    <!-- ... the rest of the interface identical to earlier (entry, materials, orders, modals) ... -->
    <div class="card" style="margin-top:12px">
      <b>Quick start</b>
      <div class="hint">Enter weight or count, then tap a material below to choose CRV / Non‑CRV (Aluminum right button = $1.75/lb).</div>
    </div>
  </div>
</div>

<!-- Cloud Config Modal -->
<dialog id="cloudModal" style="border:0;padding:0;border-radius:16px;background:#0f1730;color:var(--ink);width:min(720px,96vw)">
  <div class="card" style="border:0">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Cloud Setup (Firebase)</h3>
      <button class="btn" onclick="cloudModal.close()">✕</button>
    </div>
    <p class="hint">Using pre-baked config. You can override by pasting a new one:</p>
    <textarea id="fbCfgInput" style="width:100%;min-height:140px" placeholder='{"apiKey":"…","authDomain":"…","projectId":"…","appId":"…"}'></textarea>
    <div class="row" style="justify-content:space-between;margin-top:10px">
      <button id="disconnectCloud" class="btn danger">Disconnect</button>
      <div>
        <button id="testCloud" class="btn">Test</button>
        <button id="saveCloud" class="btn success">Connect</button>
      </div>
    </div>
    <div id="cloudMsg" class="hint" style="margin-top:6px"></div>
  </div>
</dialog>

<script>
// ---------- Helpers ----------
const $ = (q)=>document.querySelector(q);
const on = (sel, evt, fn)=>{ const el=$(sel); if(el) el.addEventListener(evt, fn, {passive:true}); };
const set = (sel, text)=>{ const el=$(sel); if(el) el.textContent = text; };
const show = (sel, yes=true)=>{ const el=$(sel); if(!el) return; el.classList.toggle('hidden', !yes); };

// Prebaked Firebase config (FIXED storageBucket)
const prebakedCfg = {
  apiKey: "AIzaSyCSRYYjuJyO6_N2n9RaA8T2fXRaHiC3q6o",
  authDomain: "recycle-cb24b.firebaseapp.com",
  projectId: "recycle-cb24b",
  storageBucket: "recycle-cb24b.appspot.com",
  messagingSenderId: "281209650356",
  appId: "1:281209650356:web:a3b55a3b4d7ce5e642abe1",
  measurementId: "G-4DFFS1RH83"
};

// Persist/override via modal if needed
try { if(!localStorage.getItem('sr_fb_config')) localStorage.setItem('sr_fb_config', JSON.stringify(prebakedCfg)); } catch(e){}
let fbCfg = null;
try { fbCfg = JSON.parse(localStorage.getItem('sr_fb_config')||'null'); } catch(e){}

let cloud = { ready:false, error:null };
let auth=null, db=null;

async function initFirebase() {
  try{
    if(!fbCfg) throw new Error('No Firebase config found');
    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
    const { getFirestore, doc, getDoc, setDoc, enableIndexedDbPersistence, Firestore } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
    const { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, onAuthStateChanged, signOut } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js');

    const app = initializeApp(fbCfg);
    auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    // Expose sign-in helpers
    window.__signIn = (email,pass)=>signInWithEmailAndPassword(auth,email,pass);
    window.__signOut = ()=>signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        set('#cloudStatus','Cloud: connected');
        set('#staffStatus', `Staff: ${user.email||user.uid}`);
        show('#authScreen', false);
        show('#appShell', true);
      }else{
        set('#cloudStatus','Cloud: sign in required');
        show('#appShell', false);
        show('#authScreen', true);
      }
    });

    cloud.ready = true;
    set('#cloudState','Cloud: ready');
  }catch(e){
    cloud.error = e;
    set('#cloudState','Cloud error: ' + (e.message||e));
    console.error('Firebase init error', e);
  }
}

// Init asap
initFirebase();

// ---------- Login UX ----------
on('#authLogin','click', async ()=>{
  const email = $('#authEmail')?.value.trim();
  const pass  = $('#authPass')?.value.trim();
  const hint  = $('#authHint');
  if(!email || !pass){ set('#authHint','Enter email and password'); return; }
  if(!cloud.ready){
    // try init again once
    await initFirebase();
    if(!cloud.ready){ set('#authHint','Cloud still loading…'); return; }
  }
  try{
    set('#authHint','Signing in…');
    await window.__signIn(email, pass);
    set('#authHint','Signed in. Loading…');
  }catch(e){
    const code = (e && e.code) ? e.code : '';
    const map = {
      'auth/invalid-email':'Invalid email address.',
      'auth/user-not-found':'No user with that email.',
      'auth/wrong-password':'Wrong password.',
      'auth/invalid-credential':'Invalid credentials.',
      'auth/network-request-failed':'Network error.'
    };
    set('#authHint', map[code] || ('Login failed: '+ code));
  }
});

// Cloud config modal
on('#cloudShow','click', ()=>{
  const ta = $('#fbCfgInput'); try{ ta.value = JSON.stringify(JSON.parse(localStorage.getItem('sr_fb_config')||'{}'), null, 2);}catch{};
  $('#cloudModal').showModal();
});
on('#disconnectCloud','click', ()=>{ localStorage.removeItem('sr_fb_config'); set('#cloudMsg','Disconnected. Reloading…'); setTimeout(()=>location.reload(),400); });
on('#testCloud','click', ()=>{ try{ JSON.parse($('#fbCfgInput').value); set('#cloudMsg','Looks valid. Click Connect to save.'); }catch{ set('#cloudMsg','Invalid JSON'); } });
on('#saveCloud','click', ()=>{ try{ localStorage.setItem('sr_fb_config', $('#fbCfgInput').value); set('#cloudMsg','Saved. Reloading…'); setTimeout(()=>location.reload(),400);}catch{ set('#cloudMsg','Couldn’t save'); } });

// ---------- Minimal post-login health check (permission clarity) ----------
window.addEventListener('load', async ()=>{
  // After a short delay, if signed in, try a harmless read to explain rules errors.
  setTimeout(async ()=>{
    try{
      if(!auth?.currentUser || !db) return;
      const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
      await getDoc(doc(db,'settings','prices'));
      // ok; nothing to show
    }catch(e){
      // If rules block, surface it in the header
      set('#cloudStatus','Cloud: permission denied (check Firestore rules email)');
    }
  }, 1200);
});
</script>
</body>
</html>
