<script>
function buildReceiptHTML(order){
  const items = (order.items||[]);
  const lines = items.map(it=>{
    const name=(materials[it.mat]||{label:it.mat}).label;
    const noPay = (it.type==='weight' && (it.payoutKind==='NON' || (typeof it.subtotal==='number' && it.subtotal===0)));
    return `<tr><td>${name}</td><td>${it.detail}${noPay?'':' '}</td></tr>`;
  }).join('');

  const lbsTotal = items.filter(it=>it.type==='weight').reduce((a,b)=>a+(+b.lbs||0),0);
  const lbsNoPay = items
    .filter(it=>it.type==='weight' && (it.payoutKind==='NON' || (typeof it.subtotal==='number' && it.subtotal===0)))
    .reduce((a,b)=>a+(+b.lbs||0),0);
  const cntCRV  = items.filter(it=>it.type==='crv').reduce((a,b)=>a+(+b.qty||0),0);

  const grand = order.totals?.grand || '$0.00';
  const when  = new Date(order.when||Date.now()).toLocaleString();
  const id    = order.id || 'UNSAVED';

  return `<!doctype html><html><head><meta charset="utf-8"><title>Receipt ${id}</title>
  <style>@media print{@page{margin:8mm}body{margin:0}}body{font-family:ui-monospace,Menlo,Consolas,monospace;color:#111;padding:12px;line-height:1.25}
  .center{text-align:center}.small{font-size:12px;color:#333}table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{padding:4px 0;border-bottom:1px dashed #ccc;font-size:14px}thead th{border-bottom:1px solid #000}
  .logo{font-weight:700;letter-spacing:.5px;font-size:16px}.barcode{width:100%;max-width:240px;margin:10px auto}.muted{color:#666}
  .box{border:1px dashed #bbb;padding:6px;border-radius:8px;margin-top:8px}</style>
  </head><body>
    <div class="center logo">Recycling Receipt</div>
    <div class="center small">${when}</div>
    <div class="small">Order ID: <b>${id}</b></div>

    <table>
      <thead><tr><th style="text-align:left">Item</th><th style="text-align:left">Detail</th></tr></thead>
      <tbody>${lines || '<tr><td colspan="2" class="muted">No items</td></tr>'}</tbody>
      <tfoot>
        <tr><td colspan="2" style="text-align:right;font-size:16px">GRAND TOTAL: <span style="display:inline-block;min-width:96px">${grand}</span></td></tr>
      </tfoot>
    </table>

    <div class="box">
      <div class="small">Summary</div>
      <div class="small">Weight received: <b>${lbsTotal.toFixed(2)} lb</b> &nbsp; | &nbsp; Non-CRV (no payout): <b>${lbsNoPay.toFixed(2)} lb</b> &nbsp; | &nbsp; CRV containers: <b>${cntCRV}</b></div>
      <div class="small muted">Non-CRV materials are accepted but do not pay out. Thanks for keeping recyclables out of landfill!</div>
    </div>

    <div class="center"><canvas id="rcptQR" class="barcode"></canvas></div>
    <div class="center small muted">Scan to pull this order in the app.</div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"><\/script>
    <script>
      try{QRCode.toCanvas(document.getElementById('rcptQR'),'${id}',{width:240,margin:1});}catch(e){}
      window.onload=()=>{setTimeout(()=>{window.print();setTimeout(()=>window.close(),300);},200);};
    <\/script>
  </body></html>`;
}
</script>
