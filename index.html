<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Login</title>
<style>
  :root{
    --bg:#070c16; --bg2:#0b1320; --card:#0f1730; --muted:#8ca0c3;
    --accent:#7dd3fc; --ok:#22c55e; --danger:#ef4444; --ink:#e5efff;
    --border:#22314f33;
  }
  [data-theme="light"]{
    --bg:#f7fafc; --bg2:#eef2f7; --card:#ffffff; --muted:#5b6b83;
    --accent:#0ea5e9; --ok:#16a34a; --danger:#dc2626; --ink:#0b1320;
    --border:#d7e0ee;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    background:radial-gradient(80vw 80vh at 10% 10%, #0f1f3d 0%, var(--bg) 60%),
               linear-gradient(180deg, var(--bg2), var(--bg) 60%);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;
    padding-bottom:env(safe-area-inset-bottom);
  }
  .hidden{display:none!important}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .pill{background:color-mix(in oklab, var(--card) 70%, #0f1a2d); border:1px solid var(--border); border-radius:999px; padding:6px 10px; white-space:nowrap}
  .btn{padding:12px 16px; cursor:pointer; transition:transform .06s ease, filter .2s ease; font:inherit; border-radius:12px; border:1px solid var(--border); background:color-mix(in oklab, var(--card) 90%, #0e1b30 14%); color:var(--ink)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:color-mix(in oklab, var(--accent) 14%, var(--card)); border-color:var(--border)}
  .btn.success{background:var(--ok); border-color:#16a34a; color:#05210f}
  .btn.danger{background:var(--danger); border-color:#b91c1c}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  input,textarea{font:inherit; border-radius:12px; border:1px solid var(--border); background:color-mix(in oklab, var(--card) 92%, #0e1b30 14%); color:var(--ink); padding:12px}
  input[type=number]{text-align:center}
  /* --- Auth Screen --- */
  #authScreen{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:24px; background:radial-gradient(60vw 60vh at 20% 10%, #11234622 0%, var(--bg) 60%); overflow:auto;}
  .auth-card{ width:min(520px, 96vw); background:color-mix(in oklab, var(--card) 70%, #111a2b22); backdrop-filter: blur(10px); border:1px solid var(--border); border-radius:18px; padding:18px; box-shadow:0 20px 80px rgba(0,0,0,.20)}
  .title{display:flex; align-items:center; gap:10px; margin:0 0 8px}
  .title .dot{width:12px; height:12px; border-radius:999px; background:var(--accent); box-shadow:0 0 16px color-mix(in oklab, var(--accent) 60%, white)}
  .subtitle{color:var(--muted); margin:0 0 12px}
  .hint{color:var(--muted); font-size:.9rem; min-height:1.2em}
  /* App shell */
  .wrap{max-width:960px; margin:0 auto; padding:14px}
  header{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .badge{font-size:.72rem; color:var(--bg2); background:var(--accent); padding:4px 8px; border-radius:999px; font-weight:700}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid var(--border); text-align:left}
  .pricecell{white-space:nowrap}
  .sticky-bottom{position:sticky; bottom:0; background:linear-gradient(180deg,transparent,var(--bg2) 24%); padding-top:6px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px}
  .mat-btn{display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center; background:color-mix(in oklab, var(--card) 92%, #0e1b3020); border:1px solid var(--border); border-radius:14px; padding:10px; min-height:104px; transition:transform .08s ease, box-shadow .2s ease}
  .mat-btn:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.15)}
  .mat-btn svg{width:40px; height:40px}
  .mat-btn span{font-size:.8rem; text-align:center}
  .fab{position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px; background:color-mix(in oklab, var(--card) 80%, #1f2b45); border:1px solid #2a3e6633; display:none; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(0,0,0,.20)}
  video{width:100%; border-radius:16px; background:#000}
  @media (max-width:420px){ header .row{gap:6px} .btn{padding:10px 12px} .grid{grid-template-columns:repeat(3,1fr)} }

  /* iPhone 15 Pro Max (portrait) */
  @supports (-webkit-touch-callout: none) {
    @media screen and (device-width:430px) and (device-height:932px) and (-webkit-device-pixel-ratio:3) and (orientation:portrait) {
      .wrap{padding:12px}
      .btn{padding:14px 16px}
      .grid{grid-template-columns:repeat(4,1fr)}
      .mat-btn{min-height:112px}
      header .row{gap:6px}
      body{padding-bottom:calc(env(safe-area-inset-bottom) + 8px)}
    }
    /* iPhone 15 Pro Max (LANDSCAPE): wizard mode */
    @media screen and (device-width:932px) and (device-height:430px) and (-webkit-device-pixel-ratio:3) and (orientation:landscape) {
      .wrap{max-width:none;padding:10px}
      .landscape-hide{display:none!important}
      .wizard{display:flex; overflow-x:hidden; height:calc(100vh - 72px); gap:0}
      .panel{flex:0 0 100%; padding:10px; overflow:auto}
      .panel > .card{margin-bottom:10px}
      #wizardNav{display:flex}
    }
  }
  /* Generic phones in LANDSCAPE â†’ wizard */
  @media (orientation:landscape) and (max-height:480px){
    .wrap{max-width:none;padding:10px}
    .landscape-hide{display:none!important}
    .wizard{display:flex; overflow-x:hidden; height:calc(100vh - 72px); gap:0}
    .panel{flex:0 0 100%; padding:10px; overflow:auto}
    .panel > .card{margin-bottom:10px}
    #wizardNav{display:flex}
  }

  /* Wizard nav */
  #wizardNav{
    display:none; position:fixed; left:0; right:0; bottom:0;
    padding:8px max(10px, env(safe-area-inset-left)) calc(8px + env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-right));
    background:linear-gradient(180deg, transparent, color-mix(in oklab, var(--bg2) 80%, #000 10%));
    backdrop-filter: blur(6px);
    align-items:center; justify-content:space-between; gap:10px; z-index:50;
  }
  .dots{display:flex; gap:6px}
  .dot{width:8px; height:8px; border-radius:50%; background:#516891}
  .dot.active{background:var(--accent)}
</style>

<!-- Third-party libs -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

<!-- Firebase (Firestore only, no Auth) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-card">
    <div class="title"><span class="dot"></span><h1 style="margin:0;font-size:1.6rem">Login</h1></div>
    <p class="subtitle">Sign in to access orders & scanning.</p>
    <div class="row" style="flex-direction:column; gap:8px">
      <label>Email</label>
      <input id="authEmail" placeholder="example@gmail.com" autocomplete="username" />
      <label>Password</label>
      <input id="authPass" type="password" placeholder="â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      <div class="row" style="justify-content:space-between; align-items:center">
        <span id="authHint" class="hint">This login is local-only. Firestore sync is automatic.</span>
        <button id="authLogin" class="btn success">Sign in</button>
      </div>
      <!-- Forgot password row -->
      <div class="row" style="justify-content:flex-end; align-items:center">
        <button id="resetPass" class="btn">Forgot password?</button>
      </div>
      <div class="row" style="justify-content:space-between; align-items:center">
        <span id="cloudState" class="pill">Cloud: connectingâ€¦</span>
        <div class="row" style="gap:6px">
          <button id="offlineBtn" class="btn">Continue as guest</button>
          <button id="apiBtn" class="btn" style="display:none">API</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- APP SHELL -->
<div id="appShell" class="hidden">
  <div class="wrap">
    <header>
      <h1>Recycling<span class="badge">POS</span></h1>
      <div class="row" style="gap:8px;align-items:center">
        <span id="cloudStatus" class="pill">Cloud: connectingâ€¦</span>
        <span id="staffStatus" class="pill">Staff: guest</span>
        <button id="scanBtn" class="btn">Scan</button>
        <button id="openPrices" class="btn">Prices</button>
        <button id="viewOrders" class="btn">Orders</button>
        <button id="themeBtn" class="btn" title="Toggle theme">â˜€ï¸Ž/ðŸŒ™</button>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </header>

    <!-- Regular layout (portrait/desktop) -->
    <div id="regularLayout">
      <div class="row" style="margin-top:12px">
        <!-- ENTRY -->
        <div id="entryCard" class="card" style="flex:1;min-width:280px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <b>Entry</b>
            <label class="row" style="align-items:center;gap:6px"><input type="checkbox" id="cntMode"><span class="hint">CNT (Count mode)</span></label>
          </div>

          <div id="weightBox" class="card" style="margin-top:10px">
            <label for="pounds">Weight (lb)</label>
            <input id="pounds" type="number" step="0.01" inputmode="decimal" min="0" value="0" enterkeyhint="done">
            <div class="hint" id="weightPreview">$0.00</div>
          </div>

          <div id="countBox" class="card" style="margin-top:10px;display:none">
            <label for="qty">Count (auto-CRV / special)</label>
            <input id="qty" type="number" inputmode="numeric" pattern="[0-9]*" value="0" min="0" enterkeyhint="done">
            <div class="hint" id="countPreview">$0.00</div>
          </div>

          <!-- Hidden but checked -->
          <div class="card" style="margin-top:10px; display:none">
            <div class="row" style="align-items:center">
              <label for="barcodeOk">Barcode verified</label>
              <input id="barcodeOk" type="checkbox" checked style="width:22px;height:22px">
            </div>
          </div>
        </div>

        <!-- ORDER -->
        <div id="orderCard" class="card" style="flex:1;min-width:280px">
          <h3 style="margin:0 0 6px">Current Order</h3>
          <div class="hint" id="chosenMatLabel" style="margin:4px 0 8px">Material: â€”</div>
          <table id="orderTable">
            <thead>
              <tr><th>Item</th><th>Detail</th><th class="pricecell">Subtotal</th><th></th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr><td colspan="2">CRV total</td><td class="pricecell" id="crvTotal">$0.00</td><td></td></tr>
              <tr><td colspan="2">Weight total</td><td class="pricecell" id="weightTotal">$0.00</td><td></td></tr>
              <tr><td colspan="2">Grand total</td><td class="pricecell" id="grandTotal">$0.00</td><td></td></tr>
            </tfoot>
          </table>
          <div class="sticky-bottom">
            <div class="row" style="justify-content:space-between;gap:8px">
              <button id="clearOrder" class="btn danger">Clear</button>
              <div class="row" style="gap:8px">
                <button id="printLast" class="btn" disabled>Receipt</button>
                <button id="saveOrder" class="btn success">Save Order</button>
              </div>
            </div>
            <p class="hint" id="saveHint"></p>
          </div>
        </div>
      </div>

      <!-- MATERIALS -->
      <div id="materialsCard" class="card" style="margin-top:12px">
        <label style="display:block;margin-bottom:8px">Materials</label>
        <div id="matGrid" class="grid"></div>
        <div id="choicePanel" class="row" style="gap:10px;display:n
