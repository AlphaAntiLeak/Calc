<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Recycling POS</title>

<style>
  :root{
    --bg:#070c16; --bg2:#0b1320; --card:#0f1730; --muted:#8ca0c3;
    --accent:#7dd3fc; --ok:#22c55e; --danger:#ef4444; --ink:#e5efff;
    --border:#22314f33;
  }
  [data-theme="light"]{
    --bg:#f7fafc; --bg2:#eef2f7; --card:#ffffff; --muted:#5b6b83;
    --accent:#0ea5e9; --ok:#16a34a; --danger:#dc2626; --ink:#0b1320;
    --border:#d7e0ee;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--ink);
    background:radial-gradient(80vw 80vh at 10% 10%, #0f1f3d 0%, var(--bg) 60%),
               linear-gradient(180deg, var(--bg2), var(--bg) 60%);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;
    padding-bottom:env(safe-area-inset-bottom);
  }
  .hidden{display:none!important}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .pill{background:color-mix(in oklab, var(--card) 70%, #0f1a2d); border:1px solid var(--border); border-radius:999px; padding:6px 10px; white-space:nowrap}
  .btn{
    padding:12px 16px; cursor:pointer;
    transition:transform .06s ease, filter .2s ease, background .15s ease, border-color .15s ease;
    font:inherit; border-radius:12px; border:1px solid var(--border);
    background:color-mix(in oklab, var(--card) 90%, #0e1b30 14%); color:var(--ink)
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:color-mix(in oklab, var(--accent) 14%, var(--card)); border-color:var(--border)}
  .btn.success{background:var(--ok); border-color:#16a34a; color:#05210f}
  .btn.danger{background:var(--danger); border-color:#b91c1c}
  .btn[disabled]{opacity:.6; cursor:not-allowed}
  input{
    font:inherit; border-radius:12px; border:1px solid var(--border);
    background:color-mix(in oklab, var(--card) 92%, #0e1b30 14%);
    color:var(--ink); padding:12px
  }
  input[type=number]{text-align:center}
  .wrap{
    max-width:1040px; margin:0 auto; padding:14px;
    display:none;
  }
  header{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    position:sticky; top:0;
    z-index:10;
    padding:8px 0 10px;
    background:linear-gradient(180deg, color-mix(in oklab,var(--bg2) 88%, #000 6%), transparent);
    backdrop-filter: blur(8px);
  }
  .badge{font-size:.72rem; color:var(--bg2); background:var(--accent); padding:4px 8px; border-radius:999px; font-weight:700}
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-bottom:1px solid var(--border); text-align:left; font-size:.92rem}
  tfoot tr:last-child td{
    font-weight:700;
    border-top:1px solid var(--border);
    font-size:1rem;
  }
  .pricecell{white-space:nowrap}
  .sticky-bottom{margin-top:8px; border-top:1px solid var(--border); padding-top:8px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px}
  .mat-btn{
    display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center;
    background:color-mix(in oklab, var(--card) 92%, #0e1b3020);
    border:1px solid var(--border); border-radius:14px;
    padding:10px; min-height:104px;
    transition:transform .08s ease, box-shadow .2s ease, border-color .12s ease, background .12s ease;
  }
  .mat-btn:hover{transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.15)}
  .mat-btn svg{width:40px; height:40px}
  .mat-btn span{font-size:.8rem; text-align:center}
  .mat-btn--selected{
    border-color:color-mix(in oklab,var(--accent) 70%, #ffffff);
    box-shadow:0 0 0 1px color-mix(in oklab,var(--accent) 40%, transparent), 0 8px 24px rgba(0,0,0,.35);
    background:color-mix(in oklab, var(--card) 78%, var(--accent) 8%);
    transform:translateY(-1px);
  }
  .hint{color:var(--muted); font-size:.9rem; min-height:1.1em}
  .hint.error{color:var(--danger)}
  .btn-ghost-danger{
    border-color:transparent;
    background:transparent;
    color:var(--danger);
    padding:6px 10px;
    font-size:.82rem;
  }
  .btn-ghost-danger:hover{
    background:color-mix(in oklab,var(--danger) 12%, transparent);
    border-color:color-mix(in oklab,var(--danger) 40%, transparent);
  }
  .pulse{
    animation:pulseTotal .28s ease-out;
  }
  @keyframes pulseTotal{
    0%{transform:scale(1); text-shadow:none;}
    40%{transform:scale(1.04); text-shadow:0 0 6px color-mix(in oklab,var(--accent) 60%, #ffffff);}
    100%{transform:scale(1); text-shadow:none;}
  }
  @media (max-width:720px){
    header{flex-direction:column; align-items:flex-start}
  }
  @media (max-width:480px){
    .mat-btn{min-height:128px}
  }

  /* Full-screen auth overlay */
  #authScreen{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    padding:24px;
    background:radial-gradient(60vw 60vh at 20% 10%, #112346aa 0%, var(--bg) 60%);
    z-index:30;
  }
  .auth-card{
    width:min(480px, 94vw);
    background:color-mix(in oklab, var(--card) 70%, #111a2b22);
    backdrop-filter: blur(10px);
    border:1px solid var(--border);
    border-radius:18px;
    padding:18px;
    box-shadow:0 20px 80px rgba(0,0,0,.25);
  }
</style>

<!-- Libraries -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
</head>
<body>

<!-- FULL-SCREEN LOGIN -->
<div id="authScreen">
  <div class="auth-card">
    <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:6px">
      <div class="row" style="align-items:center;gap:8px">
        <span style="width:12px;height:12px;border-radius:999px;background:var(--accent);box-shadow:0 0 16px color-mix(in oklab,var(--accent) 60%,white);"></span>
        <h2 style="margin:0;font-size:1.5rem">Recycling POS</h2>
      </div>
    </div>
    <p class="hint" style="margin:0 0 10px">Staff login. Only authorized staff may sign in.</p>
    <div class="row" style="flex-direction:column;gap:8px">
      <label>Email</label>
      <input id="loginEmail" placeholder="example@gmail.com" autocomplete="username" />
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      <div class="row" style="justify-content:space-between;align-items:center;margin-top:4px">
        <span id="loginHint" class="hint">Use your staff account.</span>
        <button id="loginBtn" class="btn success">Sign in</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <header>
    <h1>Recycling <span class="badge">POS</span></h1>
    <div class="row" style="gap:8px;align-items:center">
      <span id="cloudStatus" class="pill">Cloud: offline</span>
      <span id="staffStatus" class="pill">Staff: guest</span>
      <button id="scanBtn" class="btn">Scan</button>
      <button id="openPrices" class="btn">Prices</button>
      <button id="viewOrders" class="btn">Orders</button>
      <button id="themeBtn" class="btn" title="Toggle theme">â˜€ï¸Ž/ðŸŒ™</button>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </header>

  <div class="row" style="margin-top:14px">
    <!-- ENTRY -->
    <div class="card" style="flex:1; min-width:260px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <b>Entry</b>
        <label class="row" style="align-items:center;gap:6px;font-size:.9rem">
          <input type="checkbox" id="cntMode">
          <span class="hint">CNT (Count mode)</span>
        </label>
      </div>
      <div id="weightBox" class="card" style="margin-top:10px">
        <label for="pounds">Weight (lb)</label>
        <input id="pounds" type="number" step="0.01" inputmode="decimal" min="0" value="0">
        <div class="hint" id="weightPreview">$0.00</div>
      </div>
      <div id="countBox" class="card" style="margin-top:10px;display:none">
        <label for="qty">Count</label>
        <input id="qty" type="number" inputmode="numeric" pattern="[0-9]*" value="0" min="0">
        <div class="hint" id="countPreview">$0.00</div>
      </div>
    </div>

    <!-- ORDER -->
    <div class="card" style="flex:1; min-width:260px">
      <h3 style="margin:0 0 6px">Current Order</h3>
      <div class="hint" id="chosenMatLabel" style="margin:2px 0 8px">Material: â€”</div>
      <table id="orderTable">
        <thead>
          <tr><th>Item</th><th>Detail</th><th class="pricecell">Subtotal</th><th></th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="2">CRV total</td><td class="pricecell" id="crvTotal">$0.00</td><td></td></tr>
          <tr><td colspan="2">Weight total</td><td class="pricecell" id="weightTotal">$0.00</td><td></td></tr>
          <tr><td colspan="2">Grand total</td><td class="pricecell" id="grandTotal">$0.00</td><td></td></tr>
        </tfoot>
      </table>
      <div class="sticky-bottom">
        <div class="row" style="justify-content:space-between;gap:8px">
          <button id="clearOrder" class="btn danger">Clear</button>
          <div class="row" style="gap:8px">
            <button id="printLast" class="btn" disabled>Receipt</button>
            <button id="saveOrder" class="btn success" disabled>Save Order</button>
          </div>
        </div>
        <p class="hint" id="saveHint"></p>
      </div>
    </div>
  </div>

  <!-- MATERIALS -->
  <div class="card" style="margin-top:12px">
    <label style="display:block;margin-bottom:8px">Materials</label>
    <div id="matGrid" class="grid"></div>
    <div id="choicePanel" class="row" style="gap:10px;display:none;flex-wrap:wrap"></div>
    <div class="hint" id="pickedHint" style="margin-top:8px">
      Non-CRV pays $0. Aluminum right button = $1.75/lb.
    </div>
  </div>
</div>

<!-- Prices Modal -->
<dialog id="pricesModal" style="border:0;padding:0;border-radius:16px;background:var(--card);color:var(--ink);width:min(720px,92vw)">
  <div class="card" style="border:0">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Edit Prices ($/lb)</h3>
      <button class="btn" onclick="pricesModal.close()">âœ•</button>
    </div>
    <div id="priceGrid" class="row" style="flex-direction:column"></div>
    <div class="row" style="justify-content:space-between;margin-top:10px;align-items:center">
      <span id="priceSyncState" class="pill">Cloud prices: n/a</span>
      <div>
        <button class="btn" id="refreshPrices">Refresh</button>
        <button class="btn primary" id="savePrices">Save</button>
      </div>
    </div>
  </div>
</dialog>

<!-- Barcode Modal -->
<dialog id="barcodeModal" style="border:0;padding:0;border-radius:16px;background:var(--card);color:var(--ink);width:min(520px,96vw)">
  <div class="card" style="border:0">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Order Code</h3>
      <button class="btn" onclick="barcodeModal.close()">âœ•</button>
    </div>
    <div style="display:flex;justify-content:center;margin-top:10px">
      <div style="background:#ffffff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.55);max-width:360px;width:100%">
        <svg id="barcodeSVG" style="width:100%;height:120px"></svg>
      </div>
    </div>
    <div class="hint" id="barcodeHint" style="margin-top:8px;word-break:break-all;text-align:center"></div>
  </div>
</dialog>

<!-- Orders Modal -->
<dialog id="ordersModal" style="border:0;padding:0;border-radius:16px;background:var(--card);color:var(--ink);width:min(720px,96vw)">
  <div class="card" style="border:0">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Saved Orders</h3>
      <button class="btn" onclick="ordersModal.close()">âœ•</button>
    </div>
    <div class="hint" style="margin-top:4px;margin-bottom:4px">Most recent orders. Tap Barcode to reprint tag.</div>
    <div id="ordersList"></div>
  </div>
</dialog>

<!-- Scanner Modal -->
<dialog id="scanModal" style="border:0;padding:0;border-radius:16px;background:var(--card);color:var(--ink);width:min(720px,96vw)">
  <div class="card" style="border:0">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Scan Code</h3>
      <button class="btn" onclick="stopScan();scanModal.close()">âœ•</button>
    </div>
    <video id="video" playsinline style="width:100%;border-radius:12px;background:#000"></video>
    <div class="row" style="justify-content:space-between;margin-top:6px">
      <span class="pill" id="camState">Camera: idle</span>
      <button id="startCam" class="btn primary">Start</button>
    </div>
    <div id="scanResult" class="hint" style="margin-top:8px">Point camera at barcode.</div>
    <div id="scanOrder" style="display:none"></div>
  </div>
</dialog>

<script>
/* ---------- Helpers ---------- */
const $ = (q)=>document.querySelector(q);
const on = (sel, evt, fn)=>{ const el=$(sel); if(el) el.addEventListener(evt, fn); };
const money = (n)=> (isNaN(n)?0:n).toLocaleString(undefined,{style:'currency',currency:'USD'});
function setCloud(text){ $('#cloudStatus').textContent = text; }

/* Simple click lock (avoid accidental double taps) */
function lockClick(btn, fn, ms=300){
  if(!btn) return;
  if(btn.__locked) return;
  btn.__locked = true;
  Promise.resolve(fn()).finally(()=>{ setTimeout(()=>{ btn.__locked=false; }, ms); });
}

/* Theme toggle */
(function(){
  const saved = localStorage.getItem('sr_theme')||'';
  if(saved==='light') document.documentElement.setAttribute('data-theme','light');
  on('#themeBtn','click', ()=>{
    const isLight = document.documentElement.getAttribute('data-theme')==='light';
    document.documentElement.setAttribute('data-theme', isLight?'':'light');
    localStorage.setItem('sr_theme', isLight?'dark':'light');
  });
})();

/* ---------- Materials ---------- */
const icons={
  can:`<svg viewBox='0 0 64 64' fill='none'><rect x='18' y='4' width='28' height='56' rx='6' stroke='#7dd3fc' stroke-width='3'/><rect x='22' y='10' width='20' height='44' rx='3' fill='#1a2744'/></svg>`,
  bottle:`<svg viewBox='0 0 64 64' fill='none'><path d='M28 6h8v8a8 8 0 0 1 4 7v30a8 8 0 0 1-8 8h0a8 8 0 0 1-8-8V21a8 8 0 0 1 4-7V6z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/></svg>`,
  jug:`<svg viewBox='0 0 64 64' fill='none'><path d='M20 14h16l8 8v28a8 8 0 0 1-8 8H24a8 8 0 0 1-8-8V22a8 8 0 0 1 4-8z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/><rect x='36' y='18' width='10' height='8' rx='2' stroke='#7dd3fc' stroke-width='3'/></svg>`,
  glass:`<svg viewBox='0 0 64 64' fill='none'><path d='M16 6h32l-6 40a10 10 0 0 1-10 8h0a10 10 0 0 1-10-8L16 6z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/></svg>`,
  steel:`<svg viewBox='0 0 64 64' fill='none'><rect x='14' y='10' width='36' height='48' rx='6' stroke='#7dd3fc' stroke-width='3'/><path d='M18 22h28M18 30h28M18 38h28' stroke='#7dd3fc' stroke-width='2'/></svg>`,
  cup:`<svg viewBox='0 0 64 64' fill='none'><path d='M14 10h36l-6 36a10 10 0 0 1-10 8h0a10 10 0 0 1-10-8L14 10z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/></svg>`,
  seven:`<svg viewBox='0 0 64 64' fill='none'><polygon points='8,12 56,12 28,56 12,56' stroke='#7dd3fc' stroke-width='3' fill='none'/><text x='28' y='40' fill='#7dd3fc' font-size='24' text-anchor='middle' font-family='monospace'>7</text></svg>`,
  pouch:`<svg viewBox='0 0 64 64' fill='none'><path d="M20 10h24l6 10v28l-6 6H20l-6-6V20l6-10z" stroke="#7dd3fc" stroke-width="3" fill="#1a2744"/></svg>`,
  baginbox:`<svg viewBox='0 0 64 64' fill='none'><rect x='10' y='12' width='44' height='40' rx='6' stroke='#7dd3fc' stroke-width='3' fill='none'/><circle cx='46' cy='44' r='6' stroke='#7dd3fc' stroke-width='3'/><path d='M44 44h4' stroke='#7dd3fc' stroke-width='3'/></svg>`,
  carton:`<svg viewBox='0 0 64 64' fill='none'><path d='M22 12h20l6 10v28a6 6 0 0 1-6 6H22a6 6 0 0 1-6-6V22l6-10z' stroke='#7dd3fc' stroke-width='3' fill='#1a2744'/><path d='M42 12l6 10H22' stroke='#7dd3fc' stroke-width='2'/></svg>`
};

const materials={
  ALUMINUM:{label:'Aluminum',unit:'lb',icon:icons.can},
  GLASS:{label:'Glass',unit:'lb',icon:icons.glass},
  PET1:{label:'#1 PET',unit:'lb',icon:icons.bottle},
  HDPE2:{label:'#2 HDPE',unit:'lb',icon:icons.jug},
  PVC3:{label:'#3 PVC',unit:'lb',icon:icons.bottle},
  LDPE4:{label:'#4 LDPE',unit:'lb',icon:icons.bottle},
  PP5:{label:'#5 PP',unit:'lb',icon:icons.cup},
  PS6:{label:'#6 PS',unit:'lb',icon:icons.cup},
  OTHER7:{label:'#7 Other Plastic',unit:'lb',icon:icons.seven},
  BIMETAL:{label:'Bi-metal',unit:'lb',icon:icons.steel},
  Pouch:{label:'Multi-Layer Pouch',unit:'lb',icon:icons.pouch},
  BagInBox:{label:'Bag-in-Box (wine)',unit:'lb',icon:icons.baginbox},
  JuiceBox:{label:'Paperboard Carton (BeatBox)',unit:'ea',icon:icons.carton}
};

let prices = {
  ALUMINUM:1.65,GLASS:0.102,PET1:1.47,HDPE2:0.63,PVC3:0.48,LDPE4:0.98,PP5:0.55,PS6:0.31,OTHER7:0.41,BIMETAL:0.825,
  Pouch:0.41,BagInBox:3.79,JuiceBox_each:0.25
};

/* Build material grid */
(function(){
  const g = $('#matGrid');
  Object.entries(materials).forEach(([k,v])=>{
    const b=document.createElement('button');
    b.className='mat-btn';
    b.dataset.matKey=k;
    b.innerHTML=`${v.icon}<span>${v.label}</span>`;
    b.addEventListener('click',()=>onMaterial(k));
    g.appendChild(b);
  });
})();

/* CNT toggle */
function isCountMode(){ return $('#cntMode').checked; }
function updateModeUI(){
  $('#countBox').style.display = isCountMode() ? 'block' : 'none';
  $('#weightBox').style.display = isCountMode() ? 'none' : 'block';
  if(isCountMode()){
    $('#qty').focus();
  }else{
    $('#pounds').focus();
  }
}
on('#cntMode','change', ()=>updateModeUI());
updateModeUI();

/* Entry previews */
on('#pounds','input', ()=>{
  const lbs=+($('#pounds').value||0);
  const rate=(prices.ALUMINUM||0);
  $('#weightPreview').textContent = money(lbs*rate);
});
on('#qty','input', ()=>{
  const qty=+($('#qty').value||0);
  $('#countPreview').textContent = money(qty*0.05);
});

/* Enter key nudges user to materials */
['#pounds','#qty'].forEach(sel=>{
  on(sel,'keydown', e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      const grid = $('#matGrid');
      grid.scrollIntoView({behavior:'smooth',block:'center'});
      grid.classList.add('pulse');
      setTimeout(()=>grid.classList.remove('pulse'),300);
    }
  });
});

/* Order state */
let selectedMat=null;
const order=[];
let __lastSavedOrder=null;
let lastGrandTotal = 0;
let isSaving=false;

/* Material selection highlight helper */
function highlightSelectedMat(key){
  document.querySelectorAll('.mat-btn').forEach(btn=>{
    if(btn.dataset.matKey===key) btn.classList.add('mat-btn--selected');
    else btn.classList.remove('mat-btn--selected');
  });
}

/* Material click */
function onMaterial(key){
  selectedMat=key;
  $('#chosenMatLabel').textContent='Material: '+materials[key].label;
  highlightSelectedMat(key);

  const panel=$('#choicePanel');
  const grid=$('#matGrid');
  panel.innerHTML='';
  grid.style.display='none';
  panel.style.display='flex';

  const isCnt=isCountMode();
  const lbs=+($('#pounds').value||0);
  const qty=+($('#qty').value||0);

  if(isCnt){
    if(!qty){ flashHint('Enter count first'); resetMaterialChoice(); return; }
    if(key==='BagInBox' || key==='Pouch' || key==='JuiceBox'){
      panel.append(makeChoiceBtn('25Â¢ each', ()=>{ addCountItem(0.25); }));
    }else{
      panel.append(
        makeChoiceBtn('< 24 oz (5Â¢)', ()=>{ addCountItem(0.05); }),
        makeChoiceBtn('â‰¥ 24 oz (10Â¢)', ()=>{ addCountItem(0.10); })
      );
    }
  }else{
    if(!lbs){ flashHint('Enter weight first'); resetMaterialChoice(); return; }
    panel.append(
      makeChoiceBtn('CRV', ()=>{ addWeightItem('CRV'); }),
      makeChoiceBtn(key==='ALUMINUM'?'$1.75/lb':'Non-CRV', ()=>{ addWeightItem(key==='ALUMINUM'?'ALU175':'NON'); })
    );
  }
}
function makeChoiceBtn(txt, handler){
  const b=document.createElement('button');
  b.className='btn primary';
  b.textContent=txt;
  b.addEventListener('click', ()=>lockClick(b, handler));
  return b;
}
function flashHint(msg){
  const el=$('#pickedHint');
  const prev=el.textContent;
  el.textContent=msg;
  el.classList.add('error');
  setTimeout(()=>{
    el.textContent=prev;
    el.classList.remove('error');
  },1400);
}
function resetMaterialChoice(){
  selectedMat=null;
  $('#chosenMatLabel').textContent='Material: â€”';
  $('#choicePanel').style.display='none';
  $('#matGrid').style.display='grid';
  document.querySelectorAll('.mat-btn').forEach(btn=>btn.classList.remove('mat-btn--selected'));
}

/* Add items */
function addWeightItem(kind){
  if(!selectedMat) return;
  const lbs=+($('#pounds').value||0);
  if(!lbs) return;

  let rate=prices[selectedMat]||0;
  let tag='', subtotal=0;

  if(selectedMat==='ALUMINUM' && kind==='ALU175'){
    rate=1.75; tag='Alu $1.75'; subtotal=lbs*rate;
  }else if(kind==='CRV'){
    tag='CRV'; subtotal=lbs*rate;
  }else{
    tag='Non-CRV (no payout)'; subtotal=0;
  }

  order.push({
    type:'weight',
    mat:selectedMat,
    lbs,
    payoutKind:kind,
    unitPrice:rate,
    subtotal,
    detail:`${tag} Â· ${lbs.toFixed(2)} lb Ã— ${money(rate)}/lb${subtotal===0?' â€” no payout':''}`
  });

  $('#pounds').value='0';
  $('#weightPreview').textContent='$0.00';
  resetMaterialChoice();
  renderOrder();
}

function addCountItem(per){
  if(!selectedMat) return;
  const qty=+($('#qty').value||0);
  if(!qty) return;

  order.push({
    type:'crv',
    mat:selectedMat,
    qty,
    unitPrice:per,
    subtotal:qty*per,
    detail:`${qty} Ã— ${(per===0.25?'25Â¢':per===0.10?'10Â¢':'5Â¢')}`
  });

  // reset CNT and quantity after one use
  $('#qty').value='0';
  $('#countPreview').textContent='$0.00';
  $('#cntMode').checked=false;
  updateModeUI();
  resetMaterialChoice();
  renderOrder();
}

/* Enable/disable Save button */
function updateSaveEnabled(){
  const btn = $('#saveOrder');
  if(!btn) return;
  btn.disabled = isSaving || order.length===0;
}

/* Render order */
function renderOrder(){
  const tb=$('#orderTable tbody');
  tb.innerHTML='';
  let crv=0,wt=0;

  order.forEach((it,i)=>{
    const nm=(materials[it.mat]||{label:it.mat}).label;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${nm}</td><td>${it.detail}</td><td class="pricecell">${money(it.subtotal)}</td><td><button class="btn-ghost-danger" data-i="${i}">âœ•</button></td>`;
    tb.appendChild(tr);
    if(it.type==='weight') wt+=it.subtotal; else crv+=it.subtotal;
  });

  $('#crvTotal').textContent=money(crv);
  $('#weightTotal').textContent=money(wt);
  const grandCell = $('#grandTotal');
  const newGrand = crv+wt;
  grandCell.textContent=money(newGrand);

  if(newGrand !== lastGrandTotal){
    grandCell.classList.remove('pulse');
    void grandCell.offsetWidth; // force reflow
    grandCell.classList.add('pulse');
    lastGrandTotal = newGrand;
  }

  tb.querySelectorAll('button[data-i]').forEach(b=>{
    b.addEventListener('click',()=>{
      order.splice(+b.dataset.i,1);
      renderOrder();
    });
  });

  $('#printLast').disabled=!__lastSavedOrder;
  updateSaveEnabled();
}

/* Clear with confirmation */
let clearArmed=false;
on('#clearOrder','click', ()=>{
  const btn=$('#clearOrder');
  if(!order.length){ return; }
  if(!clearArmed){
    clearArmed=true;
    const prev=btn.textContent;
    btn.textContent='Tap again to clear';
    setTimeout(()=>{ clearArmed=false; btn.textContent=prev; },1500);
    return;
  }
  clearArmed=false;
  order.length=0;
  renderOrder();
});

/* ---------- Firebase ---------- */
const fbCfg = {
  apiKey: "AIzaSyCSRYYjuJyO6_N2n9RaA8T2fXRaHiC3q6o",
  authDomain: "recycle-cb24b.firebaseapp.com",
  projectId: "recycle-cb24b",
  storageBucket: "recycle-cb24b.firebasestorage.app",
  messagingSenderId: "281209650356",
  appId: "1:281209650356:web:a3b55a3b4d7ce5e642abe1",
  measurementId: "G-4DFFS1RH83"
};
firebase.initializeApp(fbCfg);
const auth = firebase.auth();
const db   = firebase.firestore();
db.enablePersistence({synchronizeTabs:true}).catch(()=>{});

/* Auth state */
auth.onAuthStateChanged(user=>{
  const app=$('.wrap');
  const authScreen=$('#authScreen');
  if(user){
    setCloud('Cloud: online (admin)');
    $('#staffStatus').textContent='Staff: '+(user.email||user.uid);
    $('#loginHint').textContent='';
    if(authScreen) authScreen.style.display='none';
    if(app) app.style.display='block';
    setTimeout(()=>$('#pounds').focus(), 200);
  }else{
    setCloud('Cloud: offline');
    $('#staffStatus').textContent='Staff: guest';
    if(app) app.style.display='none';
    if(authScreen) authScreen.style.display='flex';
  }
});

/* Login + logout */
on('#loginBtn','click', ()=>{
  const btn = $('#loginBtn');
  lockClick(btn, async ()=>{
    const email=$('#loginEmail').value.trim();
    const pass=$('#loginPass').value.trim();
    const hint=$('#loginHint');
    hint.textContent='Signing inâ€¦';
    hint.classList.remove('error');
    try{
      await auth.signInWithEmailAndPassword(email,pass);
      hint.textContent='Signed in âœ”';
      setTimeout(()=>{ hint.textContent=''; },1200);
    }catch(e){
      console.error(e);
      const code=e.code||'';
      const map={
        'auth/invalid-email':'Invalid email.',
        'auth/user-not-found':'User not found.',
        'auth/wrong-password':'Wrong password.'
      };
      hint.textContent=map[code]||('Login failed: '+code);
      hint.classList.add('error');
    }
  });
});
on('#logoutBtn','click', ()=>{
  lockClick($('#logoutBtn'), async ()=>{
    try{ await auth.signOut(); $('#loginHint').textContent='Signed out'; }catch{}
  });
});

/* ---------- Save Order to Firestore ---------- */
function currentTotals(){
  return {
    crv: $('#crvTotal').textContent||'$0.00',
    weight: $('#weightTotal').textContent||'$0.00',
    grand: $('#grandTotal').textContent||'$0.00'
  };
}
async function saveOrderToCloud(){
  const hint=$('#saveHint');
  hint.textContent='';
  hint.classList.remove('error');
  if(!order.length){ hint.textContent='Add some items first.'; return; }
  if(!auth.currentUser){ hint.textContent='Sign in as admin first.'; return; }

  const payload={
    id:'SR-'+Date.now(),
    when:new Date().toISOString(),
    items:[...order],
    totals:currentTotals()
  };

  try{
    isSaving=true;
    updateSaveEnabled();
    const btn=$('#saveOrder');
    const prevText=btn.textContent;
    btn.textContent='Savingâ€¦';
    await db.collection('orders').doc(payload.id).set(payload);
    __lastSavedOrder=payload;
    order.length=0;
    renderOrder();
    hint.textContent='Saved to cloud âœ”';
    btn.textContent=prevText;
    isSaving=false;
    updateSaveEnabled();
    setTimeout(()=>{ hint.textContent=''; },1500);
  }catch(e){
    console.error('Save failed', e);
    isSaving=false;
    updateSaveEnabled();
    hint.textContent='Save failed: '+(e.code||e.message||String(e));
    hint.classList.add('error');
  }
}
on('#saveOrder','click', ()=>lockClick($('#saveOrder'), saveOrderToCloud, 400));

/* ---------- Prices (cloud sync) ---------- */
function buildPricesForm(){
  const grid=$('#priceGrid');
  grid.innerHTML='';
  Object.keys(materials).forEach(k=>{
    if(materials[k].unit!=='lb') return;
    const row=document.createElement('div');
    row.className='row';
    row.style.flexDirection='column';
    row.innerHTML=`<label>${materials[k].label}</label>
                   <input type="number" step="0.001" id="p_${k}" value="${prices[k]??''}" placeholder="$/lb">`;
    grid.appendChild(row);
  });
  const jb=document.createElement('div');
  jb.className='row';
  jb.style.flexDirection='column';
  jb.innerHTML=`<label>Paperboard Carton (BeatBox) â€“ price each</label>
                <input type="number" step="0.01" id="p_JuiceBox_each" value="${prices.JuiceBox_each??0.25}" placeholder="$/ea">`;
  grid.appendChild(jb);
}
on('#openPrices','click', ()=>{ buildPricesForm(); pricesModal.showModal(); });

on('#refreshPrices','click', async ()=>{
  try{
    const snap=await db.collection('settings').doc('prices').get();
    if(snap.exists){
      const data=snap.data();
      if(data.map){ prices={...prices,...data.map}; buildPricesForm(); $('#priceSyncState').textContent='Cloud prices: loaded'; }
    }else{
      $('#priceSyncState').textContent='Cloud prices: not set';
    }
  }catch(e){
    console.error(e);
    $('#priceSyncState').textContent='Cloud prices: error';
  }
});
on('#savePrices','click', async ()=>{
  const next={};
  Object.keys(materials).forEach(k=>{
    if(materials[k].unit==='lb'){
      const el=$('#p_'+k);
      next[k]=+(el?.value||0)||0;
    }
  });
  next.JuiceBox_each=+(($('#p_JuiceBox_each')||{}).value||0.25)||0.25;
  prices={...prices,...next};
  try{
    await db.collection('settings').doc('prices').set({map:prices,updatedAt:new Date().toISOString()});
    $('#priceSyncState').textContent='Cloud prices: saved âœ”';
  }catch(e){
    console.error(e);
    $('#priceSyncState').textContent='Cloud prices: save error';
  }
  pricesModal.close();
});

/* ---------- Orders list + barcode + receipt ---------- */
function showBarcode(id){
  $('#barcodeHint').textContent=id;
  try{
    JsBarcode('#barcodeSVG', id, {
      format:'CODE128',
      lineColor:'#000000',
      background:'#ffffff',
      width:2,
      height:80,
      margin:6,
      displayValue:true,
      fontSize:18
    });
  }catch(e){
    console.error('Barcode error', e);
    $('#barcodeHint').textContent='Barcode error: '+(e.message||e);
  }
  barcodeModal.showModal();
}

async function printReceipt(order){
  if(!order){ alert('No order to print'); return; }
  const items=order.items||[];
  const lines=items.map(it=>{
    const name=(materials[it.mat]||{label:it.mat}).label;
    return `<tr><td>${name}</td><td>${it.detail}</td></tr>`;
  }).join('');
  const grand=order.totals?.grand||'$0.00';
  const when=new Date(order.when||Date.now()).toLocaleString();
  const id=order.id||'UNSAVED';

  const html=`<!doctype html><html><head><meta charset="utf-8"><title>${id}</title>
  <style>@media print{@page{margin:8mm}body{margin:0}}body{font-family:ui-monospace,monospace;padding:12px;color:#111}
  table{width:100%;border-collapse:collapse;margin-top:6px}th,td{padding:4px 0;border-bottom:1px dashed #ccc;font-size:14px}
  thead th{border-bottom:1px solid #000}</style></head><body>
  <div><b>Recycling Receipt</b></div>
  <div>${when}</div><div>Order ID: <b>${id}</b></div>
  <table><thead><tr><th>Item</th><th>Detail</th></tr></thead>
  <tbody>${lines||'<tr><td colspan="2">No items</td></tr>'}</tbody>
  <tfoot><tr><td colspan="2" style="text-align:right;font-size:16px">GRAND TOTAL: ${grand}</td></tr></tfoot></table>
  <script>window.onload=()=>{window.print(); setTimeout(()=>window.close(),300);};<\/script></body></html>`;
  const w=window.open('','receipt');
  if(!w){ alert('Popup blocked by browser'); return; }
  w.document.write(html);
  w.document.close();
}

on('#printLast','click', ()=>{ if(__lastSavedOrder) printReceipt(__lastSavedOrder); });

on('#viewOrders','click', async ()=>{
  const list=$('#ordersList');
  list.innerHTML='';
  try{
    const snap=await db.collection('orders').orderBy('when','desc').limit(50).get();
    if(snap.empty){ list.innerHTML='<div class="hint">No orders yet.</div>'; ordersModal.showModal(); return; }
    snap.forEach(doc=>{
      const o=doc.data();
      const div=document.createElement('div');
      div.className='card';
      const header=document.createElement('div');
      header.className='row';
      header.style.justifyContent='space-between';
      header.style.alignItems='center';

      const leftWrap=document.createElement('div');
      leftWrap.style.display='flex';
      leftWrap.style.flexDirection='column';
      leftWrap.style.gap='2px';

      const left=document.createElement('b');
      left.textContent=o.id;
      const info=document.createElement('span');
      info.className='hint';
      info.textContent=new Date(o.when).toLocaleString();
      leftWrap.append(left,info);

      const btnRow=document.createElement('div');
      btnRow.className='row';
      const codeBtn=document.createElement('button');
      codeBtn.className='btn';
      codeBtn.textContent='Barcode';
      codeBtn.addEventListener('click',()=>showBarcode(o.id));
      const rcptBtn=document.createElement('button');
      rcptBtn.className='btn';
      rcptBtn.textContent='Receipt';
      rcptBtn.addEventListener('click',()=>printReceipt(o));
      btnRow.append(codeBtn,rcptBtn);

      header.append(leftWrap,btnRow);
      const ul=document.createElement('ul');
      ul.innerHTML=(o.items||[]).map(it=>`<li>${(materials[it.mat]||{label:it.mat}).label} â€” ${it.detail} <b>${money(it.subtotal)}</b></li>`).join('');
      const totals=document.createElement('div');
      totals.className='row';
      totals.style.justifyContent='flex-end';
      totals.style.gap='16px';
      totals.innerHTML=`<span>CRV: <b>${o.totals?.crv||'$0.00'}</b></span>
                        <span>Weight: <b>${o.totals?.weight||'$0.00'}</b></span>
                        <span>Grand: <b>${o.totals?.grand||'$0.00'}</b></span>`;
      div.append(header,ul,totals);
      list.appendChild(div);
    });
    ordersModal.showModal();
  }catch(e){
    console.error(e);
    list.innerHTML='<div class="hint error">Error loading orders (check rules / auth).</div>';
    ordersModal.showModal();
  }
});

/* ---------- Scanner (barcode) ---------- */
let stream=null, codeReader=null;

on('#scanBtn','click', ()=>{
  $('#scanOrder').style.display='none';
  $('#scanResult').textContent='Point camera at barcode.';
  $('#scanResult').classList.remove('error');
  scanModal.showModal();
});
on('#startCam','click', ()=>{
  if(stream){ stopScan(); } else { startScan(); }
});
async function startScan(){
  try{
    if(!navigator.mediaDevices?.getUserMedia){
      $('#camState').textContent='Camera: unsupported';
      return;
    }
    $('#camState').textContent='Camera: startingâ€¦';
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
    const v=$('#video');
    v.srcObject=stream;
    await v.play();
    $('#camState').textContent='Camera: on âœ”';
    codeReader = new ZXing.BrowserMultiFormatReader();
    await codeReader.decodeFromVideoDevice(null, v, async (result,err)=>{
      if(result){
        const val=result.getText?result.getText():result.text||'';
        if(val){ await onScan(val); }
      }
    });
  }catch(e){
    console.error(e);
    $('#camState').textContent='Camera: error';
    $('#scanResult').textContent=e.message||e;
    $('#scanResult').classList.add('error');
  }
}
function stopScan(){
  try{
    if(codeReader){ codeReader.reset(); codeReader=null; }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    $('#camState').textContent='Camera: idle';
  }catch(e){}
}
async function onScan(val){
  stopScan();
  $('#scanResult').textContent='Scanned: '+val;
  $('#scanResult').classList.remove('error');
  let o=null;
  try{ const snap=await db.collection('orders').doc(val).get(); if(snap.exists) o=snap.data(); }catch(e){ console.error(e); }
  if(o){
    const rows=(o.items||[]).map(it=>`<li>${(materials[it.mat]||{label:it.mat}).label} â€” ${it.detail} <b>${money(it.subtotal)}</b></li>`).join('');
    $('#scanOrder').style.display='block';
    $('#scanOrder').innerHTML=`<h3 style="margin:10px 0">${o.id}</h3>
      <div class="hint">${new Date(o.when).toLocaleString()}</div>
      <ul>${rows}</ul>
      <div class="row" style="justify-content:flex-end;gap:16px">
        <span>CRV: <b>${o.totals?.crv||'$0.00'}</b></span>
        <span>Weight: <b>${o.totals?.weight||'$0.00'}</b></span>
        <span>Grand: <b>${o.totals?.grand||'$0.00'}</b></span>
      </div>`;
  }else{
    $('#scanOrder').style.display='block';
    $('#scanOrder').innerHTML="<div class='hint error'>No order with that ID.</div>";
  }
}

/* Autofocus on first load (before login state known, it'll kick in after auth too) */
window.addEventListener('load', ()=>{
  const w = $('#pounds');
  if(w){ setTimeout(()=>w.focus(), 300); }
});
</script>
</body>
</html>
